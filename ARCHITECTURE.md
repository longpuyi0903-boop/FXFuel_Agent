# 外汇周报 AI Agent 架构优化方案

## 一、问题诊断总结

### 原问题根源
1. **数据覆盖不足**：只有 FRED + Alpha Vantage 的 3-4 个数据点，LLM 被迫"补全" 90% 内容
2. **无时效性验证**：没有实时新闻源，LLM 用训练数据中的旧信息
3. **Prompt 无约束**：没有强制 LLM 只使用 context 中的数据
4. **对话 context 断裂**：追问时没有传入原始数据 + 报告

---

## 二、新架构设计

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           数据采集层 (Data Layer)                            │
├─────────────────┬─────────────────┬─────────────────┬─────────────────────────┤
│   AKShare       │   FRED API      │   网页爬取       │   金十数据(可选)         │
│   (免费/国内)    │   (免费)         │   (免费)         │   (付费/备选)           │
├─────────────────┴─────────────────┴─────────────────┴─────────────────────────┤
│                                                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │                      数据类型覆盖                                      │   │
│  ├──────────────────────────────────────────────────────────────────────┤   │
│  │ 人民币数据:                                                           │   │
│  │   - USD/CNY 中间价 (外管局/AKShare)                                   │   │
│  │   - USD/CNH 离岸即期 (AKShare)                                        │   │
│  │   - 本周中间价区间 (max/min)                                          │   │
│  │   - 中美利差 (FRED)                                                   │   │
│  ├──────────────────────────────────────────────────────────────────────┤   │
│  │ 港元数据:                                                             │   │
│  │   - USD/HKD 即期汇率 (AKShare)                                        │   │
│  │   - HIBOR 各期限 (金管局网页/AKShare)                                  │   │
│  │   - 联系汇率区间位置 (7.75-7.85)                                       │   │
│  │   - 港美利差 (HIBOR vs SOFR)                                          │   │
│  ├──────────────────────────────────────────────────────────────────────┤   │
│  │ 全球宏观:                                                             │   │
│  │   - DXY 美元指数 (AKShare)                                            │   │
│  │   - 10Y 美债收益率 (FRED)                                             │   │
│  │   - VIX 恐慌指数 (FRED)                                               │   │
│  │   - EUR/USD, USD/JPY (AKShare)                                        │   │
│  ├──────────────────────────────────────────────────────────────────────┤   │
│  │ 央行/政策事件 (新增!):                                                 │   │
│  │   - FOMC 会议结果 (金十日历/网页)                                      │   │
│  │   - 中国央行动态 (金十快讯/网页)                                       │   │
│  │   - 本周重要财经事件 (金十日历)                                        │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                      结构化数据存储 (Structured Context)                      │
├─────────────────────────────────────────────────────────────────────────────┤
│  {                                                                           │
│    "report_date": "2024-12-19",                                             │
│    "cny": {                                                                  │
│      "usdcny_mid": {"latest": 7.1876, "date": "2024-12-19"},                │
│      "usdcny_mid_weekly_range": {"high": 7.1923, "low": 7.1854},            │
│      "usdcnh_spot": 7.2856,                                                  │
│      "cny_spread": 0.098  // 离岸-在岸价差                                   │
│    },                                                                        │
│    "hkd": {                                                                  │
│      "usdhkd": 7.7725,                                                       │
│      "hibor_overnight": 4.12,                                                │
│      "hibor_1m": 4.35,                                                       │
│      "lers_position": "中间偏强"  // 相对于 7.75-7.85 区间                    │
│    },                                                                        │
│    "global": {                                                               │
│      "dxy": 107.23,                                                          │
│      "us10y": 4.52,                                                          │
│      "vix": 15.23,                                                           │
│      "eurusd": 1.0456,                                                       │
│      "usdjpy": 154.23                                                        │
│    },                                                                        │
│    "events": [                                                               │
│      {"date": "2024-12-18", "event": "FOMC会议", "result": "降息25bp",       │
│       "fed_rate": "4.25-4.50%", "source": "美联储官网"},                      │
│      {"date": "2024-12-19", "event": "中国央行MLF操作", ...}                 │
│    ],                                                                        │
│    "data_sources": {                                                         │
│      "usdcny_mid": "国家外汇管理局",                                         │
│      "usdhkd": "AKShare/东方财富",                                           │
│      ...                                                                     │
│    }                                                                         │
│  }                                                                           │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         Prompt 模板层 (严格约束)                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  SYSTEM PROMPT:                                                              │
│  """                                                                         │
│  你是一位专业的外汇市场分析师，负责撰写周度外汇市场报告。                        │
│                                                                              │
│  【核心规则 - 必须严格遵守】                                                   │
│  1. 你只能使用下方 <DATA> 标签中提供的数据撰写报告                             │
│  2. 禁止添加任何 <DATA> 中未出现的数字、日期、事件或引用                        │
│  3. 如果某类数据缺失，明确说明"数据暂缺"，不得推测或编造                        │
│  4. 所有数字必须与 <DATA> 中完全一致，不得四舍五入或换算                        │
│  5. 引用来源时，必须使用 <DATA> 中 data_sources 字段指定的来源名称              │
│                                                                              │
│  【报告结构】                                                                 │
│  1. 人民币汇率分析 (中间价、离岸价、价差、政策信号)                            │
│  2. 港元汇率分析 (联汇区间位置、HIBOR、套息交易、金管局动态)                   │
│  3. 全球外汇市场 (美元指数、主要货币对、风险情绪)                              │
│  4. 本周重要事件回顾 (仅使用 events 中的内容)                                  │
│  5. 下周展望 (基于当前数据的客观分析，避免主观预测)                            │
│  """                                                                         │
│                                                                              │
│  USER PROMPT:                                                                │
│  """                                                                         │
│  <DATA>                                                                      │
│  {structured_data_json}                                                      │
│  </DATA>                                                                     │
│                                                                              │
│  请基于以上数据撰写本周外汇市场周报。                                          │
│  """                                                                         │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           LLM 生成 + 后处理                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  1. 调用 DeepSeek API 生成报告                                               │
│  2. 数据校验层 (可选):                                                        │
│     - 提取报告中的数字，与原始数据对比                                        │
│     - 检测是否有 <DATA> 中不存在的数字                                        │
│     - 如有异常，标记警告                                                      │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           对话追问层 (RAG 一致性)                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  追问时的 PROMPT:                                                            │
│  """                                                                         │
│  【原始数据】                                                                 │
│  {structured_data_json}                                                      │
│                                                                              │
│  【已生成的报告】                                                             │
│  {generated_report}                                                          │
│                                                                              │
│  【用户追问】                                                                 │
│  {user_question}                                                             │
│                                                                              │
│  请基于原始数据和报告内容回答用户问题。                                        │
│  如果问题涉及报告/数据中没有的信息，请明确告知用户该信息不在本周数据范围内。     │
│  不要编造或推测数据中不存在的内容。                                            │
│  """                                                                         │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 三、数据源选择

### 主要数据源（全部免费）

| 数据类型 | 数据源 | 接口 | 说明 |
|---------|--------|------|------|
| 人民币中间价 | AKShare | `currency_boc_safe()` | 外管局官方数据 |
| 人民币即期汇率 | AKShare | `forex_spot_em()` | 东方财富实时数据 |
| 港元汇率 | AKShare | `forex_spot_em()` | 实时 USD/HKD |
| HIBOR | 金管局网页 | 爬虫 | 官方数据 |
| 美元指数 | AKShare | `index_us_stock_sina()` | 新浪财经 |
| 美债收益率 | FRED | `DGS10` | 官方数据 |
| VIX | FRED | `VIXCLS` | 官方数据 |
| 财经日历/新闻 | AKShare | `macro_china_rmb()` 等 | 金十数据源 |

### 备选数据源（付费/需注册）
- 金十开放平台 API：付费，但数据更全面
- NowAPI：部分免费，人民币中间价历史数据

---

## 四、关于 Perplexity 的建议

**结论：不建议作为主要数据源，但可以作为新闻补充**

原因：
1. Perplexity 的搜索结果不可控，无法保证获取到准确的中间价等数字
2. 适合用于获取定性信息（政策解读、市场评论），但不适合定量数据
3. 成本较高，API 调用有限制

**推荐方案**：
- 定量数据：AKShare + FRED（免费、稳定、官方）
- 定性新闻：AKShare 的金十数据接口 + 网页爬取
- 如需实时新闻扩展：可考虑 Perplexity 作为补充

---

## 五、文件结构

```
fx_weekly_report/
├── config.py              # 配置文件（API 密钥等）
├── data_retriever.py      # 数据采集模块
├── prompt_templates.py    # Prompt 模板
├── report_generator.py    # 报告生成器
├── data_validator.py      # 数据校验器
├── streamlit_app.py       # Streamlit 主应用
├── requirements.txt       # 依赖
└── .env                   # 环境变量
```

---

## 六、核心改进点

1. **数据覆盖率 80%+**：从 3-4 个数据点扩展到 20+ 个
2. **严格 Prompt 约束**：禁止 LLM 添加 context 外的数字/事件
3. **对话 context 保持**：追问时传入原始数据 + 报告
4. **数据校验层**：检测幻觉（可选）
5. **来源标注**：每个数据点都有明确来源

---

## 七、部署注意事项

1. AKShare 需要稳定的网络环境（国内服务器最佳）
2. FRED API 需要注册免费 Key
3. Streamlit 部署建议使用国内云服务（阿里云/腾讯云）
4. 定时任务：每周五下午自动更新数据（可选）
